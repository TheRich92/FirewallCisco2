services:
  routerfw:
    image: debian:12-slim
    container_name: routerfw
    privileged: true
    command: ["/router-entrypoint.sh"]
    volumes:
      - ./router/router-entrypoint.sh:/router-entrypoint.sh:ro
      - ./router/router-config:/router-config:ro
    networks:
      wan_net: {}
      lan_net:
        ipv4_address: 10.20.0.254
      dmz_net:
        ipv4_address: 10.30.0.254
      inet_net:
        ipv4_address: 10.10.0.254
    hostname: routerfw
    tty: true

  pc_lan:
    image: debian:12-slim
    container_name: pc_lan
    hostname: pc_lan
    cap_add: [NET_ADMIN]
    command: ["bash","-lc","apt-get update -qq && apt-get install -y -qq iproute2 inetutils-ftp iputils-ping curl netcat-openbsd >/dev/null && \
      ip route del default || true; \
      ip route add default via 10.20.0.254; \
      tail -f /dev/null"]
    networks:
      lan_net:
        ipv4_address: 10.20.0.10
    tty: true

  pc_dmz:
    image: debian:12-slim
    container_name: pc_dmz
    hostname: pc_dmz
    cap_add: [NET_ADMIN]
    command: ["bash","-lc","apt-get update -qq && apt-get install -y -qq iproute2 iputils-ping curl netcat-openbsd >/dev/null && \
      ip route del default || true; \
      ip route add default via 10.30.0.254; \
      tail -f /dev/null"]
    networks:
      dmz_net:
        ipv4_address: 10.30.0.10
    tty: true

  pc_internet:
    image: debian:12-slim
    container_name: pc_internet
    hostname: pc_internet
    cap_add: [NET_ADMIN]
    command: ["bash","-lc","apt-get update -qq && apt-get install -y -qq iproute2 iputils-ping curl netcat-openbsd >/dev/null && \
      ip route del default || true; \
      ip route add default via 10.10.0.254; \
      tail -f /dev/null"]
    networks:
      inet_net:
        ipv4_address: 10.10.0.10
    tty: true

  pc_outside_wan:
    image: debian:12-slim
    container_name: pc_outside_wan
    hostname: pc_outside_wan
    command: ["bash","-lc","apt-get update -qq && apt-get install -y -qq iproute2 curl iputils-ping netcat-openbsd >/dev/null && tail -f /dev/null"]
    networks:
      wan_net: {}
    tty: true

  web_dmz:
    image: nginx:alpine
    container_name: web_dmz
    hostname: web_dmz
    cap_add: [NET_ADMIN]
    networks:
      dmz_net:
        ipv4_address: 10.30.0.20
    volumes:
      - ./services/web_dmz/html:/usr/share/nginx/html:ro
    command: >
      sh -lc "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.30.0.254 dev eth0;
        nginx -g 'daemon off;'
      "
    tty: true


  dvwa_db:
    image: mariadb:10.6
    container_name: dvwa_db
    hostname: dvwa_db
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: dvwa
      MYSQL_USER: dvwa
      MYSQL_PASSWORD: dvwapass
    volumes:
      - ./services/dvwa/db:/var/lib/mysql
    networks:
      dmz_net:
        ipv4_address: 10.30.0.30
    tty: true

#dvwa:
#    image: ghcr.io/digininja/dvwa:latest
#    container_name: dvwa
#    depends_on:
#      - dvwa_db
#    restart: unless-stopped
#    networks:
#      dmz_net:
#        ipv4_address: 10.20.0.21
    # DVWA écoute en 80 en interne; pas de publication de port ici
    # (facultatif) Si tu as vraiment besoin de netcat dans ce conteneur :
#    command: >
#      bash -lc '
#        export DEBIAN_FRONTEND=noninteractive;
#        apt-get update -qq || true;
#        apt-get install -y -qq netcat-openbsd || true;
#        exec docker-php-entrypoint apache2-foreground'

ftp_dmz:
  image: python:3.11-slim
  container_name: ftp_dmz
  hostname: ftp_dmz
  working_dir: /srv/ftp
  cap_add: [NET_ADMIN]
  networks:
    dmz_net:
      ipv4_address: 10.30.0.50
  volumes:
    - ./services/ftp_dmz/data:/srv/ftp
    - ./services/ftp_dmz/ftp_server.py:/srv/ftp/ftp_server.py
  command: >
    bash -lc "
      pip install -q pyftpdlib &&
      ip route del default 2>/dev/null || true;
      ip route add default via 10.30.0.254 dev eth0;
      python /srv/ftp/ftp_server.py
    "
  tty: true

  ssh_dmz:
    image: debian:12-slim
    container_name: ssh_dmz
    hostname: ssh_dmz
    cap_add: [NET_ADMIN]
    networks:
      dmz_net:
        ipv4_address: 10.30.0.60
    command: >
      bash -lc "
        apt-get update -qq &&
        apt-get install -y -qq openssh-server iproute2 &&
        mkdir -p /var/run/sshd &&
        # Autoriser root + mot de passe
        sed -ri 's/^#?PermitRootLogin .*/PermitRootLogin yes/' /etc/ssh/sshd_config &&
        sed -ri 's/^#?PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config &&
        echo 'root:sshroot' | chpasswd &&
        # Route par défaut vers le routeur
        ip route del default 2>/dev/null || true;
        ip route add default via 10.30.0.254 dev eth0;
        /usr/sbin/sshd -D
      "
    tty: true


networks:
  lan_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.20.0.0/24

  dmz_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.30.0.0/24

  inet_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.0.0/24

  wan_net:
    driver: bridge

