services:
  # --- ROUTEUR / FIREWALL ---
  routerfw:
    image: debian:12-slim
    container_name: routerfw
    privileged: true
    volumes:
      - ./router/router-entrypoint.sh:/router-entrypoint.sh:ro
      - ./router/router-config:/router-config:ro
    entrypoint: ["bash", "/router-entrypoint.sh"]
    networks:
      wan_net: {}
      lan_net:
        ipv4_address: 10.20.0.254
      dmz_net:
        ipv4_address: 10.30.0.254
      inet_net:
        ipv4_address: 10.10.0.254
    hostname: routerfw
    tty: true

  # --- ZONE LAN (Administration) ---
  pc_lan:
    image: debian:12-slim
    container_name: pc_lan
    hostname: pc-lan
    networks:
      lan_net:
        ipv4_address: 10.20.0.10
    cap_add:
      - NET_ADMIN
    command: >
      bash -c "apt-get update &&
      apt-get install -y iproute2 iputils-ping curl netcat-openbsd openssh-client snmp &&
      ip route del default || true &&
      ip route add default via 10.20.0.254 &&
      tail -f /dev/null"


  pc_dmz:
    image: debian:12-slim
    container_name: pc_dmz
    hostname: pc-dmz
    networks:
      dmz_net:
        ipv4_address: 10.30.0.10
    cap_add:
      - NET_ADMIN
    command: >
      bash -c "apt-get update &&
      apt-get install -y iproute2 iputils-ping curl netcat-openbsd openssh-client snmp &&
      ip route del default || true &&
      ip route add default via 10.30.0.254 &&
      tail -f /dev/null"

  # --- ZONE DMZ (Services) ---
  web_dmz:
    image: nginx:alpine
    container_name: web_dmz
    hostname: web_dmz
    cap_add: [NET_ADMIN]
    networks:
      dmz_net:
        ipv4_address: 10.30.0.20
    volumes:
      - ./services/web_dmz/html:/usr/share/nginx/html:ro  # Optionnel si dossier existe pas
    command: >
      sh -lc "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.30.0.254 dev eth0;
        nginx -g 'daemon off;'
      "
    tty: true

  ftp_dmz:
    build: ./services/ftp_dmz
    container_name: ftp_dmz
    restart: unless-stopped
    cap_add: [NET_ADMIN]
    networks:
      dmz_net:
        ipv4_address: 10.30.0.50
    # CORRECTION ICI : On remplace '/usr/bin/python3' par 'python3' tout court
    command: >
       sh -lc "
        ip route del default 2>/dev/null || true;
        ip route add default via 10.30.0.254 dev eth0;
        python3 -m pyftpdlib -w -u user -P pass -r 21000-21010 -p 21
       "
    volumes:
      - ./services/ftp_dmz/data:/srv/ftp

  ssh_dmz:
    image: debian:12-slim
    container_name: ssh_dmz
    hostname: ssh_dmz
    cap_add: [NET_ADMIN]
    networks:
      dmz_net:
        ipv4_address: 10.30.0.60
    command: >
      bash -lc "
        apt-get update -qq &&
        apt-get install -y -qq openssh-server iproute2 &&
        mkdir -p /var/run/sshd &&
        sed -ri 's/^#?PermitRootLogin .*/PermitRootLogin yes/' /etc/ssh/sshd_config &&
        sed -ri 's/^#?PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config &&
        echo 'root:sshroot' | chpasswd &&
        ip route del default 2>/dev/null || true;
        ip route add default via 10.30.0.254 dev eth0;
        /usr/sbin/sshd -D
      "
    tty: true

  # DVWA (Cible vulnérable)
  dvwa_db:
    image: mariadb:10.6
    container_name: dvwa_db
    hostname: dvwa_db
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: dvwa
      MYSQL_USER: dvwa
      MYSQL_PASSWORD: dvwapass
    networks:
      dmz_net:
        ipv4_address: 10.30.0.31
    tty: true

  dvwa:
    image: ghcr.io/digininja/dvwa:latest
    container_name: dvwa
    depends_on:
      - dvwa_db
    restart: unless-stopped
    cap_add: [NET_ADMIN]
    networks:
      dmz_net:
        ipv4_address: 10.30.0.30
    ports:
      - "8080:80"
    # AJOUTEZ CE BLOC EXACTEMENT COMME ICI :
    environment:
      - DB_SERVER=dvwa_db
      - DB_DATABASE=dvwa
      - DB_USER=dvwa
      - DB_PASSWORD=dvwapass
      - DB_PORT=3306
    # FIN DU BLOC AJOUTÉ
    command: >
      bash -lc '
        export DEBIAN_FRONTEND=noninteractive;
        apt-get update -qq || true;
        apt-get install -y -qq iproute2 netcat-openbsd || true;
        ip route del default; ip route add default via 10.30.0.254 dev eth0;
        exec docker-php-entrypoint apache2-foreground'
    tty: true


  # --- ZONE INTERNET (Simulée + Réelle) ---
  pc_internet:
    image: debian:12-slim
    container_name: pc_internet
    hostname: pc_internet
    cap_add: [NET_ADMIN]
    command: ["bash","-lc","apt-get update -qq && apt-get install -y -qq iproute2 iputils-ping curl netcat-openbsd nmap >/dev/null && \
      ip route del default || true; \
      ip route add default via 10.10.0.254; \
      tail -f /dev/null"]
    networks:
      inet_net:
        ipv4_address: 10.10.0.10
    tty: true

  pc_outside_wan:
    image: debian:12-slim
    container_name: pc_outside_wan
    hostname: pc_outside_wan
    command: ["bash","-lc","apt-get update -qq && apt-get install -y -qq iproute2 curl iputils-ping netcat-openbsd >/dev/null && tail -f /dev/null"]
    networks:
      wan_net: {}
    tty: true

networks:
  lan_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.20.0.0/24
  dmz_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.30.0.0/24
  inet_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.0.0/24
  wan_net:
    driver: bridge